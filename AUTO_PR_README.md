# 🤖 Auto PR Generator for Kubernetes Security Fixes

This system automatically generates pull requests with security fixes for Kubernetes YAML files using LangChain and AI.

## 🚀 Features

- **Automated Security Scanning**: Scans all Kubernetes YAML files for security issues
- **AI-Powered Fixes**: Uses LangChain to generate intelligent fixes
- **Auto PR Creation**: Automatically creates pull requests with fixes
- **Smart Auto-Approval**: Auto-approves safe fixes, requires review for risky changes
- **Comprehensive Analysis**: Detects hardcoded secrets, missing limits, security contexts, etc.

## 📋 How It Works

### 1. **Security Analysis**
- Scans repository for Kubernetes YAML files
- Uses AI to identify security issues (secrets, limits, probes, etc.)
- Categorizes issues by severity (CRITICAL, HIGH, MEDIUM, LOW)

### 2. **Fix Generation**
- LangChain generates corrected YAML files
- Applies security best practices automatically
- Maintains functionality while improving security

### 3. **PR Creation**
- Creates new branch with fixes
- Generates descriptive PR with issue details
- Adds appropriate labels and reviewers

### 4. **Auto-Approval Logic**
- **Auto-approves**: Safe fixes (no HIGH severity issues)
- **Manual review**: Risky changes or HIGH severity issues
- **Smart detection**: Analyzes changes to ensure they're security-focused

## 🔧 Setup

### Required Secrets
Add these secrets to your GitHub repository:

```
OPENAI_API_KEY=your_openai_api_key
GITHUB_TOKEN=your_github_token  # Usually auto-provided
```

### Workflows
- **`auto-pr-generator.yml`**: Runs daily to scan and create PRs
- **`auto-approve.yml`**: Auto-approves safe PRs
- **`ai-review.yml`**: Original security review workflow

## 📊 Configuration

Edit `auto_pr_config.yaml` to customize:

```yaml
auto_pr:
  enabled: true
  schedule: "0 2 * * *"  # Daily at 2 AM
  auto_approve:
    enabled: true
    max_severity: "MEDIUM"
    max_changes: 50
```

## 🎯 Example Workflow

1. **Daily Scan**: System scans all Kubernetes YAML files
2. **Issue Detection**: Finds hardcoded secrets, missing limits, etc.
3. **Fix Generation**: AI generates corrected YAML
4. **PR Creation**: Creates PR with descriptive title and body
5. **Auto-Approval**: Safe fixes are auto-approved, risky ones need review

## 📝 Example PR

```markdown
## 🔒 Security Fixes for deployment.yaml

### 📊 Issues Found
- **HIGH**: 2 issues
- **MEDIUM**: 1 issue

### 🔧 Fixes Applied
- **HIGH**: Hardcoded secret in environment variable
  - *Fix*: Use secretKeyRef instead of hardcoded values
- **MEDIUM**: Missing resource limits
  - *Fix*: Add CPU and memory limits

### 🤖 Auto-Generated
This PR was automatically generated by the AI Security Review system.
```

## 🛡️ Safety Features

- **Conservative Auto-Approval**: Only approves clearly safe changes
- **Manual Review**: Requires human review for complex changes
- **Change Analysis**: AI analyzes each change for safety
- **Rollback Ready**: All changes are in separate branches

## 🔍 Monitoring

Check the Actions tab to see:
- **Auto PR Generator**: Daily scanning results
- **Auto Approve**: PR approval decisions
- **AI Review**: Security analysis results

## 🚨 Troubleshooting

### Common Issues
1. **No PRs Created**: Check if YAML files exist and have issues
2. **Auto-Approval Not Working**: Verify PR meets safety criteria
3. **API Errors**: Check OpenAI API key and GitHub token

### Debug Mode
Enable debug logging by setting environment variable:
```bash
DEBUG=true
```

## 📈 Benefits

- **Proactive Security**: Catches issues before they reach production
- **Consistent Fixes**: Applies security best practices uniformly
- **Time Saving**: Automates repetitive security fixes
- **Learning**: Team learns from AI-generated security improvements

## 🔮 Future Enhancements

- [ ] Support for Helm charts
- [ ] Integration with security scanners
- [ ] Custom fix templates
- [ ] Team-specific security policies
- [ ] Integration with CI/CD pipelines
